#!/bin/sh
set -e

[ "$CLIENT_NAME" ] || {
    echo "No client name passed. Use environment variable CLIENT_NAME."
    exit 1
}

cd /etc/openvpn
[ -f ${CLIENT_NAME}-key.pem ] ||
    openssl genrsa -out ${CLIENT_NAME}-key.pem 2048
    chmod 600 ${CLIENT_NAME}-key.pem
[ -f ${CLIENT_NAME}-csr.pem ] ||
    openssl req -new -key ${CLIENT_NAME}-key.pem -out ${CLIENT_NAME}-csr.pem -subj /CN=${CLIENT_NAME}/
[ -f ${CLIENT_NAME}-cert.pem ] ||
    openssl x509 -req -in ${CLIENT_NAME}-csr.pem -out ${CLIENT_NAME}-cert.pem -CA ca.pem -CAkey ca_pk.pem -days 36525

[ "$MY_IP_ADDR" ] || MY_IP_ADDR=$(curl -s http://myip.enix.org/REMOTE_ADDR)
[ "$MY_IP_ADDR" ] || {
    echo "Sorry, I could not figure out my public IP address."
    echo "(I use http://myip.enix.org/REMOTE_ADDR/ for that purpose.)"
    exit 1
}

[ -f ${CLIENT_NAME}.ovpn ] || cat > ${CLIENT_NAME}.ovpn <<EOF
client
nobind
dev tun
redirect-gateway def1

<key>
`cat ${CLIENT_NAME}-key.pem`
</key>
<cert>
`cat ${CLIENT_NAME}-cert.pem`
</cert>
<ca>
`cat cert.pem`
</ca>
<dh>
`cat dh.pem`
</dh>

<connection>
remote $MY_IP_ADDR 443 tcp-client
</connection>
EOF

cat ${CLIENT_NAME}.ovpn
